
<!DOCTYPE html>


<html lang="en" data-content_root="../../../../../" data-theme="dark">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>nnsight.intervention.protocols.intervention &#8212; nnsight</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "dark";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "dark";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../../../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="../../../../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../../../../_static/documentation_options.js?v=187304be"></script>
    <script src="../../../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../../../../_static/design-tabs.js?v=f930bc37"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/nnsight/intervention/protocols/intervention';</script>
    <script src="../../../../../_static/js/custom.js?v=1e4be224"></script>
    <script src="../../../../../_static/js/code.js?v=34343d0c"></script>
    <link rel="icon" href="../../../../../_static/icon.ico"/>
    <link rel="author" title="About these documents" href="../../../../../about/" />
    <link rel="index" title="Index" href="../../../../../genindex/" />
    <link rel="search" title="Search" href="../../../../../search/" />

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
<link href="../../../../../_static/css/custom.css?v=1752690525" rel="stylesheet" type="text/css" />
<link href="../../../../../_static/css/home.css?v=1752690525" rel="stylesheet" type="text/css" />

  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="dark">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../../../../search/"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../../../../">
  
  
  
  
  
    
    
    
    <img src="../../../../../_static/nnsight_logo.svg" class="logo__image only-dark" alt="nnsight - Home"/>
    <img src="../../../../../_static/nnsight_logo.svg" class="logo__image only-light pst-js-only" alt="nnsight - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../start/">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../documentation/">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../features/">
    Features
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../tutorials/">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../about/">
    About
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item"><script>
    fetch("https://ndif.dev/ping")
        .then((response) => {
            if (response.status == 200) {
                Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                    Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                        spanElement.style.setProperty('color', '#66800b', 'important');
                    });
                });
            }
            else {
                Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                    Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                        spanElement.style.setProperty('color', '#af3029', 'important');
                    });
                });
                var statusIcon = document.querySelector('.ndif .fa-circle-check');
                if (statusIcon) {
                    // not here
                    statusIcon.classList.replace('fa-circle-check', 'fa-circle-xmark'); 
                }
            }
        })
        .catch((response) => {
            Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                    spanElement.style.setProperty('color', '#af3029', 'important');
                });
            });
            var statusIcon = document.querySelector('.ndif .fa-circle-check');
            if (statusIcon) {
                statusIcon.classList.replace('fa-circle-check', 'fa-circle-xmark');
            }
        })
</script></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="/status" title="Status: Unknown" class="ndif" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-circle-check fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Status: Unknown</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ndif-team/nnsight" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.ndif.us/" title="Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Forum</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forms.gle/1Y6myaXYzSh3oHf56" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../start/">
    Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../documentation/">
    Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../features/">
    Features
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../tutorials/">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../../../../about/">
    About
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item"><script>
    fetch("https://ndif.dev/ping")
        .then((response) => {
            if (response.status == 200) {
                Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                    Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                        spanElement.style.setProperty('color', '#66800b', 'important');
                    });
                });
            }
            else {
                Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                    Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                        spanElement.style.setProperty('color', '#af3029', 'important');
                    });
                });
                var statusIcon = document.querySelector('.ndif .fa-circle-check');
                if (statusIcon) {
                    // not here
                    statusIcon.classList.replace('fa-circle-check', 'fa-circle-xmark'); 
                }
            }
        })
        .catch((response) => {
            Array.from(document.getElementsByClassName("ndif")).forEach((ndifElement) => {
                Array.from(ndifElement.getElementsByTagName('span')).forEach((spanElement) => {
                    spanElement.style.setProperty('color', '#af3029', 'important');
                });
            });
            var statusIcon = document.querySelector('.ndif .fa-circle-check');
            if (statusIcon) {
                statusIcon.classList.replace('fa-circle-check', 'fa-circle-xmark');
            }
        })
</script></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
            
          
          
          
          
          
          
          
          
          
          <a href="/status" title="Status: Unknown" class="ndif" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-circle-check fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Status: Unknown</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/ndif-team/nnsight" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://discuss.ndif.us/" title="Forum" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discourse fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Forum</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://forms.gle/1Y6myaXYzSh3oHf56" title="Discord" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-discord fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discord</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../../../../" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../../../" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">nnsight.intervention.protocols.intervention</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for nnsight.intervention.protocols.intervention</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">...</span><span class="w"> </span><span class="kn">import</span> <span class="n">util</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.entrypoint</span><span class="w"> </span><span class="kn">import</span> <span class="n">EntryPoint</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..graph</span><span class="w"> </span><span class="kn">import</span> <span class="n">InterventionNodeType</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">..interleaver</span><span class="w"> </span><span class="kn">import</span> <span class="n">Interleaver</span>

<div class="viewcode-block" id="InterventionProtocol">
<a class="viewcode-back" href="../../../../../documentation/intervention/#nnsight.intervention.protocols.intervention.InterventionProtocol">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">InterventionProtocol</span><span class="p">(</span><span class="n">EntryPoint</span><span class="p">):</span>

<div class="viewcode-block" id="InterventionProtocol.intervene">
<a class="viewcode-back" href="../../../../../documentation/intervention/#nnsight.intervention.protocols.intervention.InterventionProtocol.intervene">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">intervene</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">activations</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">module_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">module</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span>
        <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">interleaver</span><span class="p">:</span> <span class="s2">&quot;Interleaver&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Entry to intervention graph. This should be hooked to all modules involved in the intervention graph.</span>

<span class="sd">        Forms the current module_path key in the form of &lt;module path&gt;.&lt;output/input&gt;</span>
<span class="sd">        Checks the graphs InterventionProtocol attachment attribute for this key.</span>
<span class="sd">        If exists, value is a list of (start:int, end:int) subgraphs to iterate through.</span>
<span class="sd">        Node args for intervention type nodes should be ``[module_path, (batch_start, batch_size), iteration]``.</span>
<span class="sd">        Checks and updates the counter (number of times this module has been called for this Node) for the given intervention node. If count is not ready yet compared to the iteration, continue.</span>
<span class="sd">        Using batch_size and batch_start, apply torch.narrow to tensors in activations to select</span>
<span class="sd">        only batch indexed tensors relevant to this intervention node. Sets the value of a node</span>
<span class="sd">        using the indexed values. Using torch.narrow returns a view of the tensors as opposed to a copy allowing</span>
<span class="sd">        subsequent downstream nodes to make edits to the values only in the relevant tensors, and have it update the original</span>
<span class="sd">        tensors. This both prevents interventions from effecting bathes outside their preview and allows edits</span>
<span class="sd">        to the output from downstream intervention nodes in the graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            activations (Any): Either the inputs or outputs of a torch module.</span>
<span class="sd">            module_path (str): Module path of the current relevant module relative to the root model.</span>
<span class="sd">            key (str): Key denoting either &quot;input&quot; or &quot;output&quot; of module.</span>
<span class="sd">            intervention_handler (InterventionHandler): Handler object that stores the intervention graph and keeps track of module call count.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Any: The activations, potentially modified by the intervention graph.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Key to module activation intervention nodes has format: &lt;module path&gt;.&lt;output/input&gt;</span>
        <span class="n">module_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">module_path</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">interventions</span> <span class="o">=</span> <span class="n">interleaver</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">interventions</span>

        <span class="k">if</span> <span class="n">module_path</span> <span class="ow">in</span> <span class="n">interventions</span><span class="p">:</span>
            <span class="n">intervention_nodes</span> <span class="o">=</span> <span class="n">interventions</span><span class="p">[</span><span class="n">module_path</span><span class="p">]</span>

            <span class="c1"># Multiple intervention nodes can have same module_path if there are multiple invocations.</span>
            <span class="c1"># Is a set of node indexes making up the intervention subgraph</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">intervention_nodes</span><span class="p">:</span>
                
                <span class="n">node</span> <span class="o">=</span> <span class="n">interleaver</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                <span class="c1"># Args for intervention nodes are (module_path, batch_group, iteration).</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">batch_group</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">args</span>

                <span class="c1"># Updates the count of intervention node calls.</span>
                <span class="c1"># If count matches the Node&#39;s iteration, its ready to be executed.</span>
                <span class="n">ready</span><span class="p">,</span> <span class="n">defer</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">iteration</span><span class="p">)</span>
                
                <span class="c1"># Dont execute if the node isnt ready (call count / iteration) or its not fulfilled (conditional)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ready</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">value</span> <span class="o">=</span> <span class="n">activations</span>

                <span class="n">narrowed</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">interleaver</span><span class="o">.</span><span class="n">batch_groups</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                    <span class="n">batch_start</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="n">interleaver</span><span class="o">.</span><span class="n">batch_groups</span><span class="p">[</span>
                        <span class="n">batch_group</span>
                    <span class="p">]</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">narrow</span><span class="p">(</span><span class="n">acts</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>

                        <span class="k">if</span> <span class="n">acts</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">interleaver</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>

                            <span class="k">nonlocal</span> <span class="n">narrowed</span>

                            <span class="n">narrowed</span> <span class="o">=</span> <span class="kc">True</span>

                            <span class="k">return</span> <span class="n">acts</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_start</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>

                        <span class="k">return</span> <span class="n">acts</span>

                    <span class="n">value</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                        <span class="n">activations</span><span class="p">,</span>
                        <span class="n">narrow</span><span class="p">,</span>
                        <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="n">node</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

                <span class="c1"># Value injection.</span>
                <span class="n">node</span><span class="o">.</span><span class="n">set_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                
                <span class="n">node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Execute starting from start</span>
                <span class="n">node</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">],</span> <span class="n">defer</span><span class="o">=</span><span class="n">defer</span><span class="p">,</span> <span class="n">defer_start</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;defer_start&#39;</span><span class="p">])</span>

                <span class="c1"># Check if through the previous value injection, there was a &#39;swap&#39; intervention.</span>
                <span class="c1"># This would mean we want to replace activations for this batch with some other ones.</span>
                <span class="k">if</span> <span class="s1">&#39;swap&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                    <span class="n">value</span><span class="p">:</span><span class="n">InterventionNodeType</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;swap&#39;</span><span class="p">)</span>
                        
                    <span class="k">def</span><span class="w"> </span><span class="nf">_concat</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">                        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                        Concatenates or merges values from different batches.</span>
<span class="sd">                        </span>
<span class="sd">                        This function handles the &#39;swap&#39; intervention by replacing a specific batch group&#39;s</span>
<span class="sd">                        activations with new values while preserving the structure of the original activations.</span>
<span class="sd">                        </span>
<span class="sd">                        Args:</span>
<span class="sd">                            values: A list containing [original_activations, replacement_activations]</span>
<span class="sd">                                   where replacement_activations will be inserted into original_activations</span>
<span class="sd">                                   at the position specified by batch_start and batch_size.</span>
<span class="sd">                        </span>
<span class="sd">                        Returns:</span>
<span class="sd">                            The merged activations with the batch group replaced by the new values.</span>
<span class="sd">                        &quot;&quot;&quot;</span>
                        <span class="n">data_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
                            <span class="k">def</span><span class="w"> </span><span class="nf">_concat_tensor</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
<span class="w">                                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                                Concatenates tensors for the &#39;swap&#39; intervention.</span>
<span class="sd">                                </span>
<span class="sd">                                This function handles tensor concatenation by:</span>
<span class="sd">                                1. Extracting the portion before the batch to be replaced (pre)</span>
<span class="sd">                                2. Extracting the portion after the batch to be replaced (post)</span>
<span class="sd">                                3. Concatenating [pre, replacement, post] if dimensions are compatible</span>
<span class="sd">                                </span>
<span class="sd">                                Args:</span>
<span class="sd">                                    values: A list containing [original_tensor, replacement_tensor]</span>
<span class="sd">                                           where replacement_tensor will replace the section of original_tensor</span>
<span class="sd">                                           specified by batch_start and batch_size</span>
<span class="sd">                                </span>
<span class="sd">                                Returns:</span>
<span class="sd">                                    torch.Tensor: The concatenated tensor with the batch section replaced,</span>
<span class="sd">                                                 or the original tensor if dimensions don&#39;t match</span>
<span class="sd">                                &quot;&quot;&quot;</span>
                                <span class="n">pre</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">batch_start</span><span class="p">)</span>
                                <span class="n">post</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">narrow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">batch_start</span><span class="o">+</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">batch_start</span> <span class="o">-</span> <span class="n">batch_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">interleaver</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">==</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                                <span class="c1"># Verify dimensions match before concatenating</span>
                                <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">post</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="o">==</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">pre</span><span class="p">,</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">post</span><span class="p">])</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


                            <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
                                    <span class="c1"># For leaf tensors that require gradients, we need to use concatenation</span>
                                    <span class="c1"># to preserve the gradient flow</span>
                                    <span class="k">return</span> <span class="n">_concat_tensor</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># For non-leaf tensors, we can use in-place operations which are more efficient as long as </span>
                                    <span class="c1"># the view is not the output of a function that returns multiple views</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_start</span><span class="o">+</span><span class="n">batch_size</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                                        <span class="k">try</span><span class="p">:</span>
                                            <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_start</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="s2">&quot;This view is the output of a function that returns multiple views&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
                                                <span class="k">return</span> <span class="n">_concat_tensor</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="k">raise</span> <span class="n">e</span>
                                        
                                    <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_start</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                
                                <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
                            <span class="c1"># Recursively handle lists by concatenating each element</span>
                            <span class="k">return</span> <span class="p">[</span>
                                <span class="n">_concat</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="n">value_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">value_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                            <span class="p">]</span>
                        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                            <span class="c1"># Recursively handle tuples by concatenating each element</span>
                            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span>
                                <span class="p">[</span>
                                    <span class="n">_concat</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="n">value_idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
                                    <span class="k">for</span> <span class="n">value_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                            <span class="c1"># Recursively handle dictionaries by concatenating each value</span>
                            <span class="k">return</span> <span class="p">{</span>
                                <span class="n">key</span><span class="p">:</span> <span class="n">_concat</span><span class="p">([</span><span class="n">value</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>
                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                            <span class="p">}</span>
                        
                        <span class="c1"># Default case: return the original value</span>
                        <span class="k">return</span> <span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">narrowed</span><span class="p">:</span>
                        <span class="c1"># If the batch was narrowed, we need to merge the new values back into the original activations</span>
                        <span class="n">activations</span> <span class="o">=</span> <span class="n">_concat</span><span class="p">([</span><span class="n">activations</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># If the batch wasn&#39;t narrowed, we can directly replace the activations</span>
                        <span class="n">activations</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">return</span> <span class="n">activations</span></div>


    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">node</span><span class="p">:</span> <span class="s2">&quot;InterventionNodeType&quot;</span><span class="p">):</span>
        <span class="c1"># To prevent the node from looking like its executed when calling Graph.execute</span>
        <span class="n">node</span><span class="o">.</span><span class="n">executed</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="InterventionProtocol.style">
<a class="viewcode-back" href="../../../../../documentation/intervention/#nnsight.intervention.protocols.intervention.InterventionProtocol.style">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">style</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Visualization style for this protocol node.</span>

<span class="sd">        Returns:</span>
<span class="sd">            - Dict: dictionary style.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">default_style</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">style</span><span class="p">()</span>

        <span class="n">default_style</span><span class="p">[</span><span class="s2">&quot;node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;green4&quot;</span><span class="p">,</span> <span class="s2">&quot;shape&quot;</span><span class="p">:</span> <span class="s2">&quot;box&quot;</span><span class="p">}</span>
        <span class="n">default_style</span><span class="p">[</span><span class="s2">&quot;arg_kname&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;module_path&quot;</span>
        <span class="n">default_style</span><span class="p">[</span><span class="s2">&quot;arg_kname&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;batch_group&quot;</span>
        <span class="n">default_style</span><span class="p">[</span><span class="s2">&quot;arg_kname&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;call_counter&quot;</span>

        <span class="k">return</span> <span class="n">default_style</span></div>
</div>

</pre></div>

                </article>
              
              
              
              
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../../../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../../../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2025 NDIF.
      <br/>
    
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>